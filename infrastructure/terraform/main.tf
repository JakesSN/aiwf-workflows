terraform {\n  required_version = \">= 1.5.0\"\n  \n  required_providers {\n    google = {\n      source  = \"hashicorp/google\"\n      version = \"~> 5.0\"\n    }\n  }\n\n  backend \"gcs\" {\n    # Configured via workflow with -backend-config flags\n  }\n}\n\nprovider \"google\" {\n  project = var.project_id\n  region  = var.region\n}\n\ndata \"google_compute_zones\" \"available\" {\n  project = var.project_id\n  region  = var.region\n}\n\n# VPC Network\nresource \"google_compute_network\" \"aiwf_network\" {\n  name                    = \"aiwf-network\"\n  auto_create_subnetworks = false\n  project                 = var.project_id\n}\n\n# Subnet\nresource \"google_compute_subnetwork\" \"aiwf_subnet\" {\n  name          = \"aiwf-subnet\"\n  ip_cidr_range = \"10.0.0.0/24\"\n  region        = var.region\n  network       = google_compute_network.aiwf_network.id\n  project       = var.project_id\n}\n\n# Firewall - Allow SSH\nresource \"google_compute_firewall\" \"allow_ssh\" {\n  name    = \"aiwf-allow-ssh\"\n  network = google_compute_network.aiwf_network.name\n  project = var.project_id\n\n  allow {\n    protocol = \"tcp\"\n    ports    = [\"22\"]\n  }\n\n  source_ranges = [\"0.0.0.0/0\"]\n  target_tags   = [\"allow-ssh\"]\n}\n\n# Firewall - Allow HTTP/HTTPS\nresource \"google_compute_firewall\" \"allow_http_https\" {\n  name    = \"aiwf-allow-http-https\"\n  network = google_compute_network.aiwf_network.name\n  project = var.project_id\n\n  allow {\n    protocol = \"tcp\"\n    ports    = [\"80\", \"443\", \"8000\", \"8080\"]\n  }\n\n  source_ranges = [\"0.0.0.0/0\"]\n  target_tags   = [\"allow-http\"]\n}\n\n# Service Account\nresource \"google_service_account\" \"aiwf_sa\" {\n  account_id   = \"aiwf-bot\"\n  display_name = \"AIWF Bot Service Account\"\n  project      = var.project_id\n}\n\n# Compute Instance\nresource \"google_compute_instance\" \"aiwf_instance\" {\n  name         = var.instance_name\n  machine_type = var.machine_type\n  zone         = data.google_compute_zones.available.names[0]\n  project      = var.project_id\n\n  boot_disk {\n    initialize_params {\n      image = \"debian-11-bullseye-v20240110\"\n      size  = 30\n      type  = \"pd-standard\"\n    }\n  }\n\n  network_interface {\n    network    = google_compute_network.aiwf_network.name\n    subnetwork = google_compute_subnetwork.aiwf_subnet.name\n\n    access_config {\n    }\n  }\n\n  service_account {\n    email  = google_service_account.aiwf_sa.email\n    scopes = [\"cloud-platform\"]\n  }\n\n  tags = [\"allow-ssh\", \"allow-http\", \"aiwf-instance\"]\n\n  metadata = {\n    enable-oslogin = \"true\"\n  }\n\n  labels = {\n    environment = \"development\"\n    application = \"aiwf\"\n    managed-by  = \"terraform\"\n  }\n}\n\noutput \"instance_name\" {\n  value = google_compute_instance.aiwf_instance.name\n}\n\noutput \"instance_external_ip\" {\n  value = google_compute_instance.aiwf_instance.network_interface[0].access_config[0].nat_ip\n}\n\noutput \"instance_internal_ip\" {\n  value = google_compute_instance.aiwf_instance.network_interface[0].network_ip\n}\n\noutput \"instance_zone\" {\n  value = google_compute_instance.aiwf_instance.zone\n}\n